[{"title":"Hexoä¸»é¢˜ç¾åŒ–","url":"/2024/06/19/Hexo%E4%B8%BB%E9%A2%98%E7%BE%8E%E5%8C%96/","content":"<h1 id=\"è®°å½•ä¸€ä¸‹Hexoä¸»é¢˜Nextçš„ç¾åŒ–è®¾ç½®\"><a href=\"#è®°å½•ä¸€ä¸‹Hexoä¸»é¢˜Nextçš„ç¾åŒ–è®¾ç½®\" class=\"headerlink\" title=\"è®°å½•ä¸€ä¸‹Hexoä¸»é¢˜Nextçš„ç¾åŒ–è®¾ç½®\"></a>è®°å½•ä¸€ä¸‹Hexoä¸»é¢˜Nextçš„ç¾åŒ–è®¾ç½®</h1><h2 id=\"åœ†è§’ä»¥åŠé€æ˜åº¦è®¾ç½®\"><a href=\"#åœ†è§’ä»¥åŠé€æ˜åº¦è®¾ç½®\" class=\"headerlink\" title=\"åœ†è§’ä»¥åŠé€æ˜åº¦è®¾ç½®\"></a>åœ†è§’ä»¥åŠé€æ˜åº¦è®¾ç½®</h2><p>åœ¨blogâ€”â€”Homeä¸‹æ–°å»ºâ€”â€”dataæ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ–°å»ºstyles.stylæ–‡ä»¶ï¼Œå†…å®¹ï¼š</p>\n<figure class=\"highlight css\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-tag\">body</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">background</span>:<span class=\"built_in\">url</span>(<span class=\"string\">/images/background.jpg</span>);</span><br><span class=\"line\">    <span class=\"attribute\">background-repeat</span>: no-repeat;</span><br><span class=\"line\">    <span class=\"attribute\">background-attachment</span>:fixed; //ä¸é‡å¤</span><br><span class=\"line\">    <span class=\"attribute\">background-size</span>: cover;      //å¡«å……</span><br><span class=\"line\">    <span class=\"attribute\">background-position</span>:<span class=\"number\">50%</span> <span class=\"number\">50%</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//åšå®¢å†…å®¹é€æ˜åŒ–</span><br><span class=\"line\">//æ–‡ç« å†…å®¹çš„é€æ˜åº¦è®¾ç½®</span><br><span class=\"line\"><span class=\"selector-class\">.content-wrap</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">opacity</span>: <span class=\"number\">0.9</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//èœå•æ çš„é€æ˜åº¦è®¾ç½®</span><br><span class=\"line\"><span class=\"selector-class\">.header-inner</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">background</span>: <span class=\"built_in\">rgba</span>(<span class=\"number\">255</span>,<span class=\"number\">255</span>,<span class=\"number\">255</span>,<span class=\"number\">0.9</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//æœç´¢æ¡†ï¼ˆlocal-searchï¼‰çš„é€æ˜åº¦è®¾ç½®</span><br><span class=\"line\"><span class=\"selector-class\">.popup</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">opacity</span>: <span class=\"number\">0.9</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.header</span><span class=\"selector-class\">.header</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">opacity</span>: <span class=\"number\">0.9</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.site-brand-container</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">border-top-left-radius</span>: <span class=\"number\">20px</span>;</span><br><span class=\"line\">  <span class=\"attribute\">border-top-right-radius</span>: <span class=\"number\">20px</span>;</span><br><span class=\"line\">  <span class=\"attribute\">background</span>: <span class=\"built_in\">url</span>(<span class=\"string\">/images/sidebar-bg.jpg</span>);</span><br><span class=\"line\">  <span class=\"attribute\">background-size</span>: cover;</span><br><span class=\"line\">  <span class=\"attribute\">padding</span>: <span class=\"number\">10px</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.headband</span> &#123;</span><br><span class=\"line\"><span class=\"attribute\">background</span>: transparent;</span><br><span class=\"line\"><span class=\"attribute\">height</span>: <span class=\"number\">15px</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æœ€ååœ¨blog_homeç›®å½•ä¸‹çš„_config.next.ymlæ–‡ä»¶ä¸­ï¼Œå–æ¶ˆæ³¨é‡Š style: source&#x2F;_data&#x2F;styles.styl<br>é‡æ–°ç”Ÿæˆé™æ€æ–‡ä»¶å³å¯</p>\n","categories":["æŠ€æœ¯"],"tags":["Hexo"]},{"title":"bearDropper-add support for IPv6 and nftables set","url":"/2024/06/26/bearDropper-add-support-for-IPv6-and-nftables-set/","content":"<h2 id=\"æŠ˜è…¾bearDropperï¼šä½¿å…¶æ”¯æŒIPv6å’Œä½¿ç”¨nftablesæ¥å°ç¦IP\"><a href=\"#æŠ˜è…¾bearDropperï¼šä½¿å…¶æ”¯æŒIPv6å’Œä½¿ç”¨nftablesæ¥å°ç¦IP\" class=\"headerlink\" title=\"æŠ˜è…¾bearDropperï¼šä½¿å…¶æ”¯æŒIPv6å’Œä½¿ç”¨nftablesæ¥å°ç¦IP\"></a>æŠ˜è…¾bearDropperï¼šä½¿å…¶æ”¯æŒIPv6å’Œä½¿ç”¨nftablesæ¥å°ç¦IP</h2><h2 id=\"å…³äºdropbearå’ŒbearDropper\"><a href=\"#å…³äºdropbearå’ŒbearDropper\" class=\"headerlink\" title=\"å…³äºdropbearå’ŒbearDropper\"></a>å…³äºdropbearå’ŒbearDropper</h2><p>dropbearæ˜¯ä¸€ä¸ªç”¨äºåµŒå…¥å¼ç³»ç»Ÿçš„è½»é‡çº§SSHæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚å®ƒç‰¹åˆ«é€‚åˆèµ„æºå—é™çš„è®¾å¤‡ï¼Œå¦‚è·¯ç”±å™¨å’Œå°å‹ç‰©è”ç½‘è®¾å¤‡ï¼Œé€šå¸¸ç”¨äº OpenWrt ç­‰åµŒå…¥å¼æ“ä½œç³»ç»Ÿã€‚<br>è€ŒbearDropperæ˜¯é€šè¿‡è¯»å–ç³»ç»Ÿæ—¥å¿—ï¼Œè·å–ä¸€å®šæ—¶é—´å†…é¢‘ç¹ç™»å½•å¤±è´¥SSHæœåŠ¡çš„IPåœ°å€ï¼Œå°†å…¶æ·»åŠ åˆ°é˜²ç«å¢™å°ç¦åˆ—è¡¨ä¸­ï¼Œä»¥è¾¾åˆ°ä¿æŠ¤SSHæœåŠ¡å…å—çˆ†ç ´ç­‰å½±å“ã€‚<br>å°½ç®¡åœ¨å…³é—­äº†å¯†ç ç™»å½•SSHåï¼Œä½¿ç”¨key-based authenticationå·²ç»æå¤§ç¨‹åº¦ä¿æŠ¤äº†SSHæœåŠ¡ä¸è¢«çˆ†ç ´ï¼Œä½†æ˜¯åœ¨ç³»ç»Ÿæ—¥å¿—ä¸­é¢‘ç¹å‡ºç°ç™»å½•å¤±è´¥çš„æ—¥å¿—ç”šè‡³åˆ·å±ï¼Œè¿™å¯¹äºç³»ç»Ÿæ—¥å¿—çš„ç»´æŠ¤ä¹Ÿå­˜åœ¨è¾ƒå¤§ä¸è‰¯å½±å“ã€‚</p>\n<h2 id=\"ç‰ˆæœ¬å˜æ›´åŠç°å­˜é—®é¢˜\"><a href=\"#ç‰ˆæœ¬å˜æ›´åŠç°å­˜é—®é¢˜\" class=\"headerlink\" title=\"ç‰ˆæœ¬å˜æ›´åŠç°å­˜é—®é¢˜\"></a>ç‰ˆæœ¬å˜æ›´åŠç°å­˜é—®é¢˜</h2><p>åœ¨OpenWrtç³»ç»Ÿ(æœ¬äººä½¿ç”¨ImmortalWrtåˆ†æ”¯)æ›´æ–°åˆ°23.05ç‰ˆæœ¬åï¼ŒåŸæ¥é˜²ç«å¢™iptableså’Œip6tableså·²è¢«å¼ƒç”¨ï¼Œè€Œè½¬è€Œä½¿ç”¨nftablesã€‚æœ€å¼€å§‹ç‰ˆæœ¬ç”±@robzrç¼–å†™çš„<a href=\"https://github.com/robzr/bearDropper\">bearDropper</a>ä»…æ”¯æŒip(6)tablesè¯­å¥ï¼Œç»ç”±@marjancinoberä¿®æ”¹åè½¬ä¸º<a href=\"https://github.com/marjancinober/bearDropper\">æ”¯æŒnftablesçš„bearDropper</a>ã€‚</p>\n<p>è¿‘å¹´æ¥IPv6çš„æ¨å¹¿å·²å¾—åˆ°æå¤§æ”¯æŒï¼Œå®¶å®½åŸºæœ¬å·²ç»å®ç°IPv4å’ŒIPv6åŒæ ˆï¼Œè€Œä¸Šè¿°ä¿®æ”¹ç‰ˆbearDropperä»…æ”¯æŒIPv4åœ°å€çš„è¯†åˆ«ï¼Œåœ¨æœ‰IPv6åœ°å€è®¿é—®å¤±è´¥çš„è®°å½•ä¸‹ï¼Œå¤§æ¦‚ç‡å‡ºç°malformaté”™è¯¯ï¼š<br><code>authpriv.notice bearDropper[xxxxx]: processLogLine(,171xxxxxxx) malformed line (authpriv.info dropbear[xxxxx]: Exit before auth from &lt;2a06:4880:d000::e8:34201&gt;: Exited normally)</code></p>\n<p>å¦ä¸€ä¸ªæœ¬äººè§‰å¾—ä¸å¤Ÿç®€æ´çš„åœ°æ–¹åœ¨äºï¼Œä¿®æ”¹ç‰ˆbearDropperä¼šåœ¨input_wanå’Œforward_wané“¾æ’å…¥ä¸€ä¸ªåä¸ºbearDropperé“¾çš„å¼•ç”¨ï¼Œè€ŒbearDropperé“¾ä¸‹æ˜¯ä¸€æ¡æ¡å°ç¦IPçš„dropè§„åˆ™ï¼Œå½“å°ç¦IPæ•°é‡è¾ƒå¤§æ—¶å¯èƒ½å­˜åœ¨ä¸€å®šçš„æ€§èƒ½é—®é¢˜ï¼ˆç”±äºéœ€è¦ç”±ä¸Šè‡³ä¸‹ä¸€æ¡æ¡åŒ¹é…IPè§„åˆ™ï¼‰ï¼Œå¹¶ä¸”åœ¨ç³»ç»Ÿé˜²ç«å¢™ç•Œé¢ä¸‹ä¹Ÿç›¸åº”åœ°ä¼šæœ‰å¾ˆé•¿ä¸€æ®µçš„dropè§„åˆ™ã€‚</p>\n<p>å¦å¤–ä¸çŸ¥é“æ˜¯ç”±äºä»€ä¹ˆåŸå› ï¼Œåœ¨followæ¨¡å¼ä¸‹çš„bearDropperç»å¸¸å‡ºç°æ— å“åº”çš„æƒ…å†µï¼Œè¡¨ç°ä¸ºå°½ç®¡æœ‰IPè¾¾åˆ°å°ç¦æ¡ä»¶ï¼Œä½†æ˜¯bearDropperæ— ååº”ï¼ŒçŒœæµ‹ä¸å‡ºç°çš„malformaté”™è¯¯æœ‰å…³ã€‚äºæ˜¯å¼€å§‹æŠ˜è…¾ä¹‹æ—…ï¼š</p>\n<h2 id=\"æŠ˜è…¾ç›®æ ‡\"><a href=\"#æŠ˜è…¾ç›®æ ‡\" class=\"headerlink\" title=\"æŠ˜è…¾ç›®æ ‡\"></a>æŠ˜è…¾ç›®æ ‡</h2><ol>\n<li>æ”¯æŒIPv6åœ°å€çš„è¯†åˆ«å’Œå°ç¦</li>\n<li>ä½¿ç”¨nftables setæ¥å­˜å‚¨å°ç¦çš„IPåœ°å€</li>\n</ol>\n<h2 id=\"æ”¹å†™è¿‡ç¨‹ï¼šIPç›¸å…³å‡½æ•°\"><a href=\"#æ”¹å†™è¿‡ç¨‹ï¼šIPç›¸å…³å‡½æ•°\" class=\"headerlink\" title=\"æ”¹å†™è¿‡ç¨‹ï¼šIPç›¸å…³å‡½æ•°\"></a>æ”¹å†™è¿‡ç¨‹ï¼šIPç›¸å…³å‡½æ•°</h2><p>bearDropperé‡‡ç”¨shellè¯­è¨€ç¼–å†™ï¼Œå¯ç›´æ¥é˜…è¯»åˆ†ææºç ã€‚</p>\n<h3 id=\"å‡½æ•°ï¼šgetLogIP\"><a href=\"#å‡½æ•°ï¼šgetLogIP\" class=\"headerlink\" title=\"å‡½æ•°ï¼šgetLogIP\"></a>å‡½æ•°ï¼š<em>getLogIP</em></h3><p>é¦–å…ˆåˆ†æå‡½æ•°ï¼š<em>getLogIP</em></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">getLogIP () &#123; </span><br><span class=\"line\">  local logLine=&quot;$1&quot;</span><br><span class=\"line\">  local ebaPID=$(echo &quot;$logLine&quot; | sed -n &#x27;s/^.*authpriv.info \\(dropbear\\[[0-9]*\\]:\\) Exit before auth.*/\\1/p&#x27;)</span><br><span class=\"line\">  [ -n &quot;$ebaPID&quot; ] &amp;&amp; logLine=$($cmdLogreadEba | grep -F &quot;$&#123;ebaPID&#125; Child connection from &quot;)</span><br><span class=\"line\">  echo &quot;$logLine&quot; | sed -n &#x27;s/^.*[^0-9]\\([0-9][0-9]*\\.[0-9][0-9]*\\.[0-9][0-9]*\\.[0-9][0-9]*\\).*$/\\1/p&#x27;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"># Args: $1=log line</span><br></pre></td></tr></table></figure>\n<p>é‡Œé¢å…³äºebaPIDçš„2è¡Œä»£ç æ˜¯æ ¹æ®dropbearçš„è¿›ç¨‹IDæ¥è·å–å¯¹åº”çš„<code>Child connection from xxx.xxx.xxx.xxx</code>å’Œ<code>Exit before auth from &lt;xxx.xxx.xxx.xxx&gt;</code>2è¡Œæ—¥å¿—ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªç™»å½•å¤±è´¥ï¼Œè¿™2è¡Œæ—¥å¿—æ˜¯æˆå¯¹å‡ºç°çš„ã€‚è€Œæœ€åä¸€è¡Œä»£ç ä¸­çš„sedè¯­å¥åˆ™æ˜¯æå–ä¼ å…¥å˜é‡$logLineä¸­çš„IPv4åœ°å€çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚<br>è¦ä½¿å…¶è¯†åˆ«IPv6åœ°å€å¾ˆç®€å•ï¼Œåªéœ€è¦æŠŠå¯¹åº”çš„è¡¨è¾¾å¼æ¢æˆè¯†åˆ«IPv6çš„å³å¯ï¼Œåœ¨ç½‘ä¸ŠæŸ¥è¯¢ä¸€ä¸‹å¾ˆå¿«ä¾¿æ‰¾åˆ°äº†ä¸€ä¸ª<a href=\"https://stackoverflow.com/questions/53497/regular-expression-that-matches-valid-ipv6-addresses\">ç›¸å…³è®¨è®º</a>:</p>\n<blockquote>\n<p>IPv6 addressesï¼š<br>zero compressed IPv6 addresses (section 2.2 of rfc5952)<br>link-local IPv6 addresses with zone index (section 11 of rfc4007)<br>IPv4-Embedded IPv6 Address (section 2 of rfc6052)<br>IPv4-mapped IPv6 addresses (section 2.1 of rfc2765)<br>IPv4-translated addresses (section 2.1 of rfc2765)<br>IPv6 Regular Expression:</p>\n<p>(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}| ::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]).){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]).){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))</p>\n</blockquote>\n<p>å¥½é•¿ä¸€ä¸²ï¼Œæ¯•ç«ŸIPv6åœ°å€æ¯”è¾ƒå¤æ‚ä¸”æœ‰å¤šç§å½¢å¼ï¼Œå…·ä½“åˆ°å®ç°ä¸Šï¼Œå…ˆå°†<em>getLogIP</em> å‡½æ•°æ”¹å†™æˆï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">getLogIP () &#123;</span><br><span class=\"line\">  local logLine=&quot;$1&quot;</span><br><span class=\"line\">  local ip=$(getLogIPv6 &quot;$logLine&quot;)</span><br><span class=\"line\">  [ -z &quot;$ip&quot; ] &amp;&amp; ip=$(getLogIPv4 &quot;$logLine&quot;)</span><br><span class=\"line\">  [ -z &quot;$ip&quot; ] &amp;&amp; logLine 1 &quot;Error: getLogIp() malformed line ($logLine)&quot;</span><br><span class=\"line\">  echo &quot;$ip&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å¹¶æ·»åŠ 2ä¸ªå‡½æ•°<em>getLotIPv4</em> å’Œ<em>getLotIPv6</em> ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">getLogIPv4 () &#123; </span><br><span class=\"line\">  local logLine=&quot;$1&quot;</span><br><span class=\"line\">  local ebaPID=$(echo &quot;$logLine&quot; | sed -n &#x27;s/^.*authpriv.info \\(dropbear\\[[0-9]*\\]:\\) Exit before auth.*/\\1/p&#x27;)</span><br><span class=\"line\">  [ -n &quot;$ebaPID&quot; ] &amp;&amp; logLine=$($cmdLogreadEba | grep -F &quot;$&#123;ebaPID&#125; Child connection from &quot;)</span><br><span class=\"line\">  local ip=$(echo &quot;$logLine&quot; | sed -n &#x27;s/^.*[^0-9]\\([0-9][0-9]*\\.[0-9][0-9]*\\.[0-9][0-9]*\\.[0-9][0-9]*\\).*$/\\1/p&#x27;)</span><br><span class=\"line\">  echo &quot;$ip&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">getLogIPv6 () &#123;</span><br><span class=\"line\">  local logLine=&quot;$1&quot;</span><br><span class=\"line\">  local ebaPID=$(echo &quot;$logLine&quot; | sed -n &#x27;s/^.*authpriv.info \\(dropbear\\[[0-9]*\\]:\\) Exit before auth.*/\\1/p&#x27;)</span><br><span class=\"line\">  [ -n &quot;$ebaPID&quot; ] &amp;&amp; logLine=$($cmdLogreadEba | grep -F &quot;$&#123;ebaPID&#125; Child connection from &quot;)</span><br><span class=\"line\">  local ip=$(echo &quot;$logLine&quot; | grep -o -E &#x27;(([0-9a-fA-F]&#123;1,4&#125;:)&#123;7,7&#125;[0-9a-fA-F]&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,7&#125;:|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,6&#125;:[0-9a-fA-F]&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,5&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,2&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,4&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,3&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,3&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,2&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,5&#125;|[0-9a-fA-F]&#123;1,4&#125;:((:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,6&#125;)|:((:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,7&#125;|:)|fe80:(:[0-9a-fA-F]&#123;0,4&#125;)&#123;0,4&#125;%[0-9a-zA-Z]&#123;1,&#125;|::(ffff(:0&#123;1,4&#125;)&#123;0,1&#125;:)&#123;0,1&#125;((25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])\\.)&#123;3,3&#125;(25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,4&#125;:((25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])\\.)&#123;3,3&#125;(25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9]))&#x27;)</span><br><span class=\"line\">  echo &quot;$ip&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™æ ·å¯ä»¥åœ¨ä¸æ”¹å˜å…¶ä»–åœ°æ–¹å¯¹äº<em>getLogIP</em>å‡½æ•°çš„è°ƒç”¨æƒ…å†µä¸‹å®Œæˆå¯¹IPv6çš„æ”¯æŒï¼Œè¿™é‡Œé¢ä¹Ÿå·äº†ä¸€ç‚¹å°æ‡’ï¼Œé¦–å…ˆç›´æ¥ç”¨IPv6çš„regexè¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…åˆ°å†è¿›ä¸€æ­¥ä½¿ç”¨IPv4çš„è¡¨è¾¾å¼è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœå‡æ— æ³•åŒ¹é…ï¼Œåˆ™å…ˆæç¤ºæŠ¥é”™å§ï½ï½</p>\n<h3 id=\"æ·»åŠ getIPtypeå‡½æ•°\"><a href=\"#æ·»åŠ getIPtypeå‡½æ•°\" class=\"headerlink\" title=\"æ·»åŠ getIPtypeå‡½æ•°\"></a>æ·»åŠ getIPtypeå‡½æ•°</h3><p>å¯¹äºè·å–åˆ°çš„IPåœ°å€ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<em>getIPtype</em> å‡½æ•°æ¥åˆ¤æ–­IP_Typeæ˜¯IPv4è¿˜æ˜¯IPv6:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># determine if IP is IPv4 or IPv6, Args: $1=IP</span><br><span class=\"line\">getIPtype () &#123;</span><br><span class=\"line\">  local ip=&quot;$1&quot;</span><br><span class=\"line\">  local ipv4_regex=&quot;^([0-9]&#123;1,3&#125;\\.)&#123;3&#125;[0-9]&#123;1,3&#125;$&quot;</span><br><span class=\"line\">  local ipv6_regex=&quot;(([0-9a-fA-F]&#123;1,4&#125;:)&#123;7,7&#125;[0-9a-fA-F]&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,7&#125;:|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,6&#125;:[0-9a-fA-F]&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,5&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,2&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,4&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,3&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,3&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,4&#125;|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,2&#125;(:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,5&#125;|[0-9a-fA-F]&#123;1,4&#125;:((:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,6&#125;)|:((:[0-9a-fA-F]&#123;1,4&#125;)&#123;1,7&#125;|:)|fe80:(:[0-9a-fA-F]&#123;0,4&#125;)&#123;0,4&#125;%[0-9a-zA-Z]&#123;1,&#125;|::(ffff(:0&#123;1,4&#125;)&#123;0,1&#125;:)&#123;0,1&#125;((25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])\\.)&#123;3,3&#125;(25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])|([0-9a-fA-F]&#123;1,4&#125;:)&#123;1,4&#125;:((25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9])\\.)&#123;3,3&#125;(25[0-5]|(2[0-4]|1&#123;0,1&#125;[0-9])&#123;0,1&#125;[0-9]))&quot;</span><br><span class=\"line\">  if [[ $ip =~ $ipv4_regex ]]; then echo &quot;ipv4&quot;</span><br><span class=\"line\">  elif [[ $ip =~ $ipv6_regex ]]; then echo &quot;ipv6&quot;</span><br><span class=\"line\">  else echo &quot;invalid&quot;</span><br><span class=\"line\">  fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å‡½æ•°ï¼šbanIP\"><a href=\"#å‡½æ•°ï¼šbanIP\" class=\"headerlink\" title=\"å‡½æ•°ï¼šbanIP\"></a>å‡½æ•°ï¼š<em>banIP</em></h3><p>ä¸‹é¢æ˜¯å¯¹ä¸»è¦å‡½æ•°<em>banIP</em> çš„åˆ†æå’Œä¿®æ”¹ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Args: $1=IP</span><br><span class=\"line\">banIP () &#123;</span><br><span class=\"line\">  local ip=&quot;$1&quot;</span><br><span class=\"line\">  if ! nft list chain inet fw4 $firewallChain &gt;/dev/null 2&gt;/dev/null ; then  </span><br><span class=\"line\">    logLine 1 &quot;Creating nft chain $firewallChain&quot;</span><br><span class=\"line\">    nft add chain inet fw4 $firewallChain</span><br><span class=\"line\">  fi</span><br><span class=\"line\">  for x in $firewallHookChains ; do</span><br><span class=\"line\">    chain=&quot;$&#123;x%:*&#125;&quot; ; position=&quot;$&#123;x#*:&#125;&quot;</span><br><span class=\"line\">    if [ $position -ge 0 ] &amp;&amp;  ! nft -a list chain inet fw4 $chain 2&gt;/dev/null | grep -qE &quot;\\\\t+jump $firewallChain\\&gt;&quot; ; then</span><br><span class=\"line\">      logLine 1 &quot;Inserting hook into nft chain $chain&quot;</span><br><span class=\"line\">      if [ $position = 0 ] ; then</span><br><span class=\"line\">        _hl=$(nft -a list chain inet fw4 $chain | sed -En &#x27;s/\\t*jump .* # handle //p&#x27; | tail -n1)</span><br><span class=\"line\">        if [ -z &quot;$_hl&quot; ] ; then nft add rule inet fw4 $chain jump $firewallChain</span><br><span class=\"line\">        else nft insert rule inet fw4 $chain handle $_hl jump $firewallChain ; fi</span><br><span class=\"line\">      else</span><br><span class=\"line\">       \tnft insert rule inet fw4 $chain index $((position-1)) jump $firewallChain</span><br><span class=\"line\">    fi ; fi </span><br><span class=\"line\">  done</span><br><span class=\"line\">  if ! nft list chain inet fw4 $firewallChain | grep -q &quot;saddr $ip .*$firewallTarget&quot; 2&gt;/dev/null ; then</span><br><span class=\"line\">    logLine 1 &quot;Inserting ban rule for IP $ip into nft chain $firewallChain&quot;</span><br><span class=\"line\">    nft add rule inet fw4 $firewallChain ip saddr $ip &quot;$firewallTarget&quot;</span><br><span class=\"line\">  else</span><br><span class=\"line\">    logLine 3 &quot;banIP() rule for $ip already present in nft chain&quot;</span><br><span class=\"line\">  fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>é»˜è®¤é…ç½®é‡Œï¼Œ$firewallChainå€¼ä¸ºbearDropper, $firewallHookChainsä¸ºåˆ—è¡¨[input_wan:1, forward_wan:1]ï¼Œæ¯ä¸ªå…ƒç´ ï¼šå‰ä¸ºé˜²ç«å¢™chainï¼Œåä¸ºæ·»åŠ çš„positionï¼ˆ1è¡¨ç¤ºinsertï¼Œ0è¡¨ç¤ºappendåˆ°æœ€åï¼Œ-1è¡¨ç¤ºä¸æ·»åŠ ï¼‰ï¼Œå‡½æ•°é‡Œç¬¬ä¸€ä¸ªifåˆ¤æ–­bearDropperé“¾æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºè¯¥é“¾ï¼Œåœ¨forå¾ªç¯é‡Œæ ¹æ®$firewallHookChainsåˆ—è¡¨é‡Œchainå’Œpositionæ¥ç¡®å®šæ·»åŠ åˆ°å“ªä¸ªé“¾åŠä½ç½®ã€‚æœ€åä¸€ä¸ªifåˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨è¯¥IPçš„bané“¾äº†ï¼Œæ— åˆ™æ·»åŠ ï¼Œæœ‰åˆ™logæç¤ºã€‚</p>\n<p>é‚£æˆ‘ä»¬å¦‚ä½•ä¿®æ”¹ä½¿å…¶æ”¯æŒIPv6ï¼Œå¹¶ä¸”ä¸å†ä½¿ç”¨<code>nft add rule inet fw4 $firewallChain ip saddr $ip &quot;$firewallTarget&quot;</code>æ·»åŠ dropé“¾çš„å½¢å¼ï¼Œè€Œè½¬ç”¨setçš„å½¢å¼å‘¢ï¼Ÿ<br>é¦–å…ˆï¼Œæ–°å»ºsetçš„nftè¯­å¥æ˜¯ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">nft create set inet fw4 $set_name_1 &#123; type ipv4_addr \\; flags interval \\; auto-merge \\; &#125; </span><br><span class=\"line\">nft create set inet fw4 $set_name_2 &#123; type ipv6_addr \\; flags interval \\; auto-merge \\; &#125; </span><br></pre></td></tr></table></figure>\n<p>å¯ä»¥çœ‹åˆ°ï¼Œnftçš„setæ˜¯IPv4å’ŒIPv6åˆ†å¼€çš„ï¼Œä¸¤ç§IPåœ°å€ä¸èƒ½å­˜åœ¨ä¸€ä¸ªsetä¸­ã€‚auto-mergeæ˜¯ç›¸é‚»IPæ·»åŠ è¿›å»åä¼šè¢«è‡ªåŠ¨å­˜ä¸ºIP Rangeæ ¼å¼ï¼šx.x.x.1-x.x.x.5,ç”šè‡³æ›´å¤šçš„åœ°å€ä¼šèåˆæˆIP CIDRæ ¼å¼ã€‚</p>\n<p>å°†IPæ·»åŠ åˆ°setçš„nftè¯­å¥æ˜¯ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">nft add element inet fw4 $set_name &#123; $ip &#125; </span><br></pre></td></tr></table></figure>\n<p>æ³¨æ„æ ¹æ®$ipçš„ç±»å‹ï¼Œå­˜åˆ°å„è‡ªç±»å‹çš„setä¸­ï¼Œè¿™æ—¶å€™ï¼Œå‰é¢å†™çš„<em>getIPtype</em> å‡½æ•°å°±èƒ½å‘æŒ¥ç”¨å¤„äº†ã€‚æˆ‘ä»¬è¿˜æ˜¯æ ¹æ®ä¸Šé¢çš„æƒ³æ³•ï¼Œæ·»åŠ 2ä¸ªå‡½æ•°æ¥åˆ†åˆ«å¤„ç†IPv4å’ŒIPv6:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Args: $1=IP</span><br><span class=\"line\">banIPv4 () &#123;</span><br><span class=\"line\">  local ip=&quot;$1&quot;</span><br><span class=\"line\">  if ! nft list set inet fw4 $&#123;firewallChain&#125;_v4 &gt;/dev/null 2&gt;/dev/null ; then</span><br><span class=\"line\">    logLine 1 &quot;Creating nft set $&#123;firewallChain&#125;_v4&quot;</span><br><span class=\"line\">    nft create set inet fw4 $&#123;firewallChain&#125;_v4 &#123; type ipv4_addr \\; flags interval \\; auto-merge \\; &#125;</span><br><span class=\"line\">  fi</span><br><span class=\"line\"></span><br><span class=\"line\">  for x in $firewallHookChains ; do</span><br><span class=\"line\">    chain=&quot;$&#123;x%:*&#125;&quot; ; position=&quot;$&#123;x#*:&#125;&quot;</span><br><span class=\"line\">    if [ $position -ge 0 ] &amp;&amp;  ! nft -a list chain inet fw4 $chain 2&gt;/dev/null | grep -qE &quot;\\\\t+ip saddr @$&#123;firewallChain&#125;_v4 $firewallTarget&quot; ; then</span><br><span class=\"line\">      logLine 1 &quot;Inserting IPv4 hook into nft chain $chain&quot;</span><br><span class=\"line\">      if [ $position = 0 ] ; then</span><br><span class=\"line\">        _hl=$(nft -a list chain inet fw4 $chain | sed -En &#x27;s/\\t*ip saddr @$&#123;firewallChain&#125;_v4 $firewallTarget # handle //p&#x27; | tail -n1)</span><br><span class=\"line\">        if [ -z &quot;$_hl&quot; ] ; then nft add rule inet fw4 $chain ip saddr @$&#123;firewallChain&#125;_v4 $firewallTarget</span><br><span class=\"line\">        else nft insert rule inet fw4 $chain handle $_hl ip saddr @$&#123;firewallChain&#125;_v4 $firewallTarget ; fi</span><br><span class=\"line\">      else</span><br><span class=\"line\">       \tnft insert rule inet fw4 $chain index $((position-1)) ip saddr @$&#123;firewallChain&#125;_v4 $firewallTarget</span><br><span class=\"line\">    fi ; fi </span><br><span class=\"line\">  done</span><br><span class=\"line\">  if [ -z &quot;$(nft list set inet fw4 $&#123;firewallChain&#125;_v4 | grep $&#123;ip&#125;)&quot; ] ; then</span><br><span class=\"line\">    logLine 1 &quot;Inserting IP $ip into nft set $&#123;firewallChain&#125;_v4&quot;</span><br><span class=\"line\">    nft add element inet fw4 $&#123;firewallChain&#125;_v4 &#123;$ip&#125;</span><br><span class=\"line\">  else</span><br><span class=\"line\">    logLine 2 &quot;banIPv4() IP $ip already in nft set $&#123;firewallChain&#125;_v4&quot;</span><br><span class=\"line\">  fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ€è·¯å¾ˆæ¸…æ¥šäº†ï¼Œä¸»è¦ä¿®æ”¹ç‚¹å¦‚ä¸‹ï¼š<br>    1. ç¬¬ä¸€ä¸ªifé‡Œï¼ŒæŠŠåŸå‡½æ•°çš„<code>add chain inet fw4 $firewallChain</code>æ”¹ä¸º<code>create set inet fw4 $&#123;firewallChain&#125;_v4</code>ï¼Œv4åç¼€ä»£è¡¨è¿™ä¸ªsetå‚¨å­˜IPv4åœ°å€<br>    2. forå¾ªç¯é‡Œï¼ŒæŠŠ<code>nft add rule inet fw4 $chain jump $firewallChain</code>çš„é“¾å¼•ç”¨åŠè·³è½¬æ”¹ä¸ºç¬¦åˆsource addråœ¨setå†…æ¡ä»¶ä¸‹ç›´æ¥$firewallTarget, å³<code>nft add rule inet fw4 $chain ip saddr @$&#123;firewallChain&#125;_v4 $firewallTarget</code>ï¼ŒæŠŠé™„è¿‘çš„å‡ å¤„åˆ¤æ–­å’Œgrepè¯­å¥ä¹Ÿè¿›è¡Œç›¸åº”çš„ä¿®æ”¹ã€‚è¿™æ ·è°ƒæ•´åbançš„IPv4å°†è¿›å…¥åä¸º${firewallChain}_v4ï¼ˆé»˜è®¤ä¸ºbearDropper_v4ï¼‰çš„setä¸­ï¼Œé€šè¿‡åœ¨chainé‡Œæ·»åŠ æ¡ä»¶ç¬¦åˆip saddr @${firewallChain}_v4çš„IPè¿›è¡Œ$firewallTargetï¼ˆé»˜è®¤ä¸ºdropï¼‰ã€‚<br>    3. æŠŠv4æ¢æˆv6ï¼Œå†™ä¸€ä¸ªå‡ ä¹ä¸€æ ·çš„<em>banIPv6</em> å‡½æ•°ï¼š<br>    <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">banIPv6 () &#123;</span><br><span class=\"line\">    local ip=&quot;$1&quot;</span><br><span class=\"line\">    if ! nft list set inet fw4 $&#123;firewallChain&#125;_v6 &gt;/dev/null 2&gt;/dev/null ; then</span><br><span class=\"line\">        logLine 1 &quot;Creating nft set $&#123;firewallChain&#125;_v6&quot;</span><br><span class=\"line\">        nft create set inet fw4 $&#123;firewallChain&#125;_v6 &#123; type ipv6_addr \\; flags interval \\; auto-merge \\; &#125;</span><br><span class=\"line\">    fi</span><br><span class=\"line\">  </span><br><span class=\"line\">    for x in $firewallHookChains ; do</span><br><span class=\"line\">        chain=&quot;$&#123;x%:*&#125;&quot; ; position=&quot;$&#123;x#*:&#125;&quot;</span><br><span class=\"line\">        if [ $position -ge 0 ] &amp;&amp;  ! nft -a list chain inet fw4 $chain 2&gt;/dev/null | grep -qE &quot;\\\\t+ip6 saddr @$&#123;firewallChain&#125;_v6 $firewallTarget&quot; ; then</span><br><span class=\"line\">            logLine 1 &quot;Inserting IPv6 hook into nft chain $chain&quot;</span><br><span class=\"line\">            if [ $position = 0 ] ; then</span><br><span class=\"line\">                _hl=$(nft -a list chain inet fw4 $chain | sed -En &#x27;s/\\t*ip6 saddr @$&#123;firewallChain&#125;_v6 $firewallTarget # handle //p&#x27; | tail -n1)</span><br><span class=\"line\">                if [ -z &quot;$_hl&quot; ] ; then nft add rule inet fw4 $chain ip6 saddr @$&#123;firewallChain&#125;_v6 $firewallTarget</span><br><span class=\"line\">                else nft insert rule inet fw4 $chain handle $_hl ip6 saddr @$&#123;firewallChain&#125;_v6 $firewallTarget ; fi</span><br><span class=\"line\">            else</span><br><span class=\"line\">   \t            nft insert rule inet fw4 $chain index $((position-1)) ip6 saddr @$&#123;firewallChain&#125;_v6 $firewallTarget</span><br><span class=\"line\">        fi ; fi </span><br><span class=\"line\">    done</span><br><span class=\"line\">    if [ -z &quot;$(nft list set inet fw4 $&#123;firewallChain&#125;_v6 | grep $&#123;ip&#125;)&quot; ] ; then</span><br><span class=\"line\">        logLine 1 &quot;Inserting IP $ip into nft set $&#123;firewallChain&#125;_v6&quot;</span><br><span class=\"line\">        nft add element inet fw4 $&#123;firewallChain&#125;_v6 &#123;$ip&#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">        logLine 2 &quot;banIPv6() IP $ip already in nft set $&#123;firewallChain&#125;_v6&quot;</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure><br>æœ€ååœ¨æ”¹å†™åŸæ¥çš„<em>banIP</em> å‡½æ•°ï¼Œè°ƒç”¨getIPtypeæ¥å†³å®šä½¿ç”¨<em>banIPv4</em> è¿˜æ˜¯<em>banIPv6</em> ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">banIP () &#123;</span><br><span class=\"line\">  local ip=&quot;$1&quot;</span><br><span class=\"line\">  local type=$(getIPtype &quot;$ip&quot;)</span><br><span class=\"line\">  case $type in</span><br><span class=\"line\">    ipv4) banIPv4 &quot;$ip&quot; ;;</span><br><span class=\"line\">    ipv6) banIPv6 &quot;$ip&quot; ;;</span><br><span class=\"line\">    *) logLine 1 &quot;Error: banIP() invalid IP address ($ip)&quot; ;;</span><br><span class=\"line\">  esac</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å‡½æ•°unBanIP\"><a href=\"#å‡½æ•°unBanIP\" class=\"headerlink\" title=\"å‡½æ•°unBanIP\"></a>å‡½æ•°<em>unBanIP</em></h3><p>ä¸‹é¢æ˜¯å¯¹ä¸»è¦å‡½æ•°<em>unBanIP</em> çš„åˆ†æå’Œä¿®æ”¹ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Args: $1=IP</span><br><span class=\"line\">unBanIP () &#123;</span><br><span class=\"line\">  local ip=&quot;$1&quot;</span><br><span class=\"line\">  _hl=$(nft -a list chain inet fw4 $firewallChain 2&gt;/dev/null | sed -n &quot;/ saddr $ip /&#123;s|\\t*ip saddr $ip .*$firewallTarget # handle ||p;q&#125;&quot;)</span><br><span class=\"line\">  if [ &quot;$_hl&quot; ] ; then</span><br><span class=\"line\">    logLine 1 &quot;Removing ban rule for IP $ip from nft&quot;</span><br><span class=\"line\">    nft delete rule inet fw4 bearDropper handle $_hl</span><br><span class=\"line\">  else</span><br><span class=\"line\">    logLine 3 &quot;unBanIP() Ban rule for $ip not present in nft&quot;</span><br><span class=\"line\">  fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>é»˜è®¤é…ç½®é‡Œï¼Œ$firewallChainå€¼ä¸ºbearDropper, $firewallTargetå€¼ä¸ºdropã€‚å‡½æ•°ç¬¬äºŒè¡Œæ˜¯ä¸ºäº†è·å–nftablesé‡ŒbearDropperé“¾ä¸‹$ipå¯¹åº”çš„handleï¼ˆå³ä½ç½®æ ‡è¯†ç¬¦ï¼‰ï¼Œå¦‚æœå­˜åœ¨åˆ™åˆ æ‰è¯¥handleï¼Œä¸å­˜åœ¨åˆ™æŠ›å‡ºä¸€ä¸ªæ—¥å¿—ï¼Œæç¤ºnot present<br>æ·»åŠ IPv6æ”¯æŒï¼Œå¦‚æ³•ç‚®åˆ¶ï¼Œåˆ†å‡º2ä¸ªå‡½æ•°<em>unBanIPv4</em> å’Œ<em>unBanIPv6</em> :</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Args: $1=IP</span><br><span class=\"line\">unBanIPv4 () &#123;</span><br><span class=\"line\">  local ip=&quot;$1&quot;</span><br><span class=\"line\">  if ! nft delete element inet fw4 $&#123;firewallChain&#125;_v4 &#123;$ip&#125; &gt;/dev/null 2&gt;/dev/null ; then</span><br><span class=\"line\">    logLine 3 &quot;unBanIP() $ip not present in nft set $&#123;firewallChain&#125;_v4&quot;</span><br><span class=\"line\">  else</span><br><span class=\"line\">    logLine 1 &quot;Removing IP $ip from nft set&quot;</span><br><span class=\"line\">  fi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">unBanIPv6 () &#123;</span><br><span class=\"line\">  local ip=&quot;$1&quot;</span><br><span class=\"line\">  if ! nft delete element inet fw4 $&#123;firewallChain&#125;_v6 &#123;$ip&#125; &gt;/dev/null 2&gt;/dev/null ; then</span><br><span class=\"line\">    logLine 3 &quot;unBanIP() $ip not present in nft&quot;</span><br><span class=\"line\">  else</span><br><span class=\"line\">    logLine 1 &quot;Removing IP $ip from nft set $&#123;firewallChain&#125;_v6&quot;</span><br><span class=\"line\">  fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å‡½æ•°wipeFirewall\"><a href=\"#å‡½æ•°wipeFirewall\" class=\"headerlink\" title=\"å‡½æ•°wipeFirewall\"></a>å‡½æ•°<em>wipeFirewall</em></h3><p>å¯¹ä¸»è¦å‡½æ•°<em>wipeFirewall</em> çš„åˆ†æå’Œä¿®æ”¹ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">wipeFirewall () &#123;</span><br><span class=\"line\">  local x chain position</span><br><span class=\"line\">  for x in $firewallHookChains ; do</span><br><span class=\"line\">    chain=&quot;$&#123;x%:*&#125;&quot; ; position=&quot;$&#123;x#*:&#125;&quot;</span><br><span class=\"line\">    if [ $position -ge 0 ] ; then</span><br><span class=\"line\">      _hl=$(nft -a list chain inet fw4 $chain 2&gt;/dev/null | sed -nE &quot;s/\\\\t+jump $firewallChain # handle //p&quot;)</span><br><span class=\"line\">      if [ &quot;$_hl&quot; ] ; then</span><br><span class=\"line\">        logLine 1 &quot;Removing hook from nft chain $chain&quot;</span><br><span class=\"line\">        nft delete rule inet fw4 $chain handle $_hl</span><br><span class=\"line\">    fi ; fi</span><br><span class=\"line\">  done</span><br><span class=\"line\">  if nft list chain inet fw4 $firewallChain &gt;/dev/null 2&gt;/dev/null ; then</span><br><span class=\"line\">    logLine 1 &quot;Flushing and removing nft chain $firewallChain&quot;</span><br><span class=\"line\">    nft flush chain inet fw4 $firewallChain 2&gt;/dev/null</span><br><span class=\"line\">    nft delete chain inet fw4 $firewallChain 2&gt;/dev/null</span><br><span class=\"line\">  fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯åœ¨ç¨‹åºå‡çº§ï¼Œé€€å‡ºï¼Œæˆ–è€…æ‰‹åŠ¨æ‰§è¡Œwipeçš„æƒ…å†µä¸‹ï¼Œå¯¹å·²æœ‰é“¾å’ŒIP dropè§„åˆ™çš„æ¸…æ¥šï¼Œæ”¹èµ·æ¥ä¹Ÿæ˜¯é’ˆå¯¹ç›¸åº”çš„chainå’Œruleè¿›è¡Œä¿®æ”¹ï¼Œæ”¹ä¸ºæˆ‘ä»¬çš„setå’Œdelete elmentå³å¯ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„åŸæ¥çš„æ¯ä¸ªchainå¯¹åº”ä¸€ä¸ª$firewallChainï¼Œè€Œæˆ‘ä»¬ä¿®æ”¹åæ˜¯æœ‰v4å’Œv6ä¸¤ä¸ªsetçš„,éœ€è¦åˆ†åˆ«è·å–å¯¹åº”çš„handleï¼Œç„¶ådelete rule by handleï¼Œæœ€åflush setï¼Œdelete setå³å¯ã€‚ä¿®æ”¹åçš„å‡½æ•°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">wipeFirewall () &#123;</span><br><span class=\"line\">  local x chain position</span><br><span class=\"line\">  for x in $firewallHookChains ; do</span><br><span class=\"line\">    chain=&quot;$&#123;x%:*&#125;&quot; ; position=&quot;$&#123;x#*:&#125;&quot;</span><br><span class=\"line\">    if [ $position -ge 0 ] ; then</span><br><span class=\"line\">      _hl4=$(nft -a list chain inet fw4 $chain 2&gt;/dev/null | sed -nE &quot;s/\\\\t+ip saddr @$&#123;firewallChain&#125;_v4 $firewallTarget # handle //p&quot;)</span><br><span class=\"line\">      _hl6=$(nft -a list chain inet fw4 $chain 2&gt;/dev/null | sed -nE &quot;s/\\\\t+ip6 saddr @$&#123;firewallChain&#125;_v6 $firewallTarget # handle //p&quot;)</span><br><span class=\"line\">      if [ &quot;$_hl4&quot; ] ; then</span><br><span class=\"line\">        logLine 1 &quot;Removing IPv4 hook from nft chain $chain&quot;</span><br><span class=\"line\">        nft delete rule inet fw4 $chain handle $_hl4</span><br><span class=\"line\">      fi</span><br><span class=\"line\">      if [ &quot;$_hl6&quot; ] ; then</span><br><span class=\"line\">        logLine 1 &quot;Removing IPv6 hook from nft chain $chain&quot;</span><br><span class=\"line\">        nft delete rule inet fw4 $chain handle $_hl6</span><br><span class=\"line\">      fi</span><br><span class=\"line\">    fi</span><br><span class=\"line\">  done</span><br><span class=\"line\">  if nft list set inet fw4 $&#123;firewallChain&#125;_v4 &gt;/dev/null 2&gt;/dev/null ; then</span><br><span class=\"line\">    logLine 1 &quot;Flushing and removing nft set $&#123;firewallChain&#125;_v4&quot;</span><br><span class=\"line\">    nft flush set inet fw4 $&#123;firewallChain&#125;_v4 2&gt;/dev/null</span><br><span class=\"line\">    nft delete set inet fw4 $&#123;firewallChain&#125;_v4 2&gt;/dev/null</span><br><span class=\"line\">  fi</span><br><span class=\"line\">  if nft list set inet fw4 $&#123;firewallChain&#125;_v6 &gt;/dev/null 2&gt;/dev/null ; then</span><br><span class=\"line\">    logLine 1 &quot;Flushing and removing nft setÃŸ $&#123;firewallChain&#125;_v6&quot;</span><br><span class=\"line\">    nft flush set inet fw4 $&#123;firewallChain&#125;_v6 2&gt;/dev/null</span><br><span class=\"line\">    nft delete set inet fw4 $&#123;firewallChain&#125;_v6 2&gt;/dev/null</span><br><span class=\"line\">  fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å°ç»“ï¼šå…³äºIPçš„å‡½æ•°æ“ä½œ\"><a href=\"#å°ç»“ï¼šå…³äºIPçš„å‡½æ•°æ“ä½œ\" class=\"headerlink\" title=\"å°ç»“ï¼šå…³äºIPçš„å‡½æ•°æ“ä½œ\"></a>å°ç»“ï¼šå…³äºIPçš„å‡½æ•°æ“ä½œ</h3><p>ä¸Šé¢çš„å‡ ä¸ªå‡½æ•°å‡æ˜¯å…³äºæ—¥å¿—ä¸­IPçš„æå–å’Œå¯¹åº”nftè§„åˆ™çš„æ·»åŠ æˆ–è€…åˆ é™¤ã€‚è€ŒbearDropperè¿˜å†…ç½®äº†ä¸€å¥—ç®€æ˜“çš„æ•°æ®åº“ç³»ç»Ÿï¼Œä»¥è®°å½•bançš„æ—¶é—´ï¼Œå¦‚æœè¾¾åˆ°configä¸­è®¾ç½®çš„benlengthæ—¶é•¿ï¼Œå¯¹äºè¿™äº›â€œè¿‡æœŸâ€çš„IPåœ°å€ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦æ”¾å‡ºæ¥çš„ï¼Œä¹Ÿå³ä½¿ç”¨unBanIPå‡½æ•°ï¼Œä½†æ˜¯å…³äºè¿™ä¸ªå»ºè®®æ•°æ®åº“å¯¹äºIPv6çš„æ”¯æŒå’Œä¿®æ”¹ä¹Ÿæ˜¯éœ€è¦ç»§ç»­æŠ˜è…¾çš„ã€‚å½“åˆæˆ‘è¿˜ä»¥ä¸ºä¿®æ”¹å®Œè¿™å‡ ä¸ªå‡½æ•°å°±å¯ä»¥è¿è¡Œäº†ï¼Œä½†æ˜¯åœ¨è™šæ‹Ÿæœºçš„æµ‹è¯•ä¸­å‘ç°ï¼ŒIPåœ°å€è¦å…ˆè¿›å…¥å®ƒçš„æ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œè¿›è¡Œæ¬¡æ•°å’Œæ—¶é•¿çš„åˆ¤æ–­ï¼Œç¨‹åºæ‰ä¼šè¿›ä¸€æ­¥å†³å®šæ˜¯å¦è¾¾åˆ°bançš„æ ‡å‡†çš„ï¼Œè¿˜æ˜¯å¤ªå¹´è½»ã€‚ç»§ç»­æŠ˜è…¾å§ï¼ï½</p>\n<h2 id=\"æ”¹å†™è¿‡ç¨‹ï¼šbddbæ•°æ®åº“ç›¸å…³å‡½æ•°\"><a href=\"#æ”¹å†™è¿‡ç¨‹ï¼šbddbæ•°æ®åº“ç›¸å…³å‡½æ•°\" class=\"headerlink\" title=\"æ”¹å†™è¿‡ç¨‹ï¼šbddbæ•°æ®åº“ç›¸å…³å‡½æ•°\"></a>æ”¹å†™è¿‡ç¨‹ï¼šbddbæ•°æ®åº“ç›¸å…³å‡½æ•°</h2><h3 id=\"ç®€æ˜“bddbæ•°æ®åº“\"><a href=\"#ç®€æ˜“bddbæ•°æ®åº“\" class=\"headerlink\" title=\"ç®€æ˜“bddbæ•°æ®åº“\"></a>ç®€æ˜“bddbæ•°æ®åº“</h3><p>åœ¨åŸç‰ˆåŠä¿®æ”¹ç‰ˆçš„bearDropperè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šåœ¨<code>/tmp</code>ç›®å½•ä¸‹ç”ŸæˆbearDropper.bddbæ–‡ä»¶ï¼Œä½¿ç”¨<code>cat</code>å‘½ä»¤å¯ä»¥ç›´æ¥æ‰“å¼€ï¼Œå‘ç°å®ƒæ˜¯å¦‚ä¸‹çš„æ–‡ä»¶æ ¼å¼ï¼š</p>\n<blockquote>\n<p>bddb_101_43_93_18&#x3D;1,1719324346<br>bddb_116_140_208_227&#x3D;0,1719380201,1719380202<br>bddb_139_9_71_115&#x3D;1,1719378933<br>bddb_141_98_11_82&#x3D;1,1719345816<br>bddb_14_103_20_212&#x3D;1,1719356376</p>\n</blockquote>\n<p>å¾ˆæ˜æ˜¾ï¼Œæ¯è¡Œä»¥bddb_å¼€å¤´ï¼ŒIPv4åœ°å€çš„<code>.</code>å…¨éƒ¨è½¬æ¢æˆäº†ä¸‹åˆ’çº¿<code>_</code>ï¼Œ<code>=</code>å·è¿æ¥äº†0&#x2F;1,[timestamp1],[timestamp2],â€¦ å†ç®€å•ç¿»çœ‹äº†bddbç›¸å…³å‡½æ•°åï¼Œå‘ç°æ•°å­—0ï¼Œä»£è¡¨æš‚æœªè¾¾åˆ°å°ç¦æ¡ä»¶ï¼Œåé¢è·Ÿçš„ä¸€ç³»åˆ—æ•°å­—æ˜¯%såŒ–åçš„æ—¶é—´æˆ³ï¼Œæ¯åœ¨syslogé‡Œæœ‰ä¸€æ¬¡å¤±è´¥ç™»å½•ï¼ŒbearDropperå°±ä¼šåœ¨åé¢åŠ ä¸Šä¸€æ¬¡å¯¹åº”çš„æ—¶é—´æˆ³ã€‚è§„å®šæ—¶é—´å†…å¦‚æœè¾¾åˆ°äº†ä¸€å®šæ¬¡æ•°count($stamp), ç¨‹åºå°±å›è°ƒç”¨banIPå‡½æ•°ï¼Œå¹¶ä¸”åœ¨bddbä¸­ä¿®æ”¹0 &#x3D;&gt; 1, åŒæ—¶æ›´æ–°timestampä¸ºå°ç¦çš„æ—¶é—´æˆ³ã€‚</p>\n<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹bddbç›¸å…³çš„é‡è¦å‡½æ•°ï¼š</p>\n<h3 id=\"å‡½æ•°bddbClear\"><a href=\"#å‡½æ•°bddbClear\" class=\"headerlink\" title=\"å‡½æ•°bddbClear\"></a>å‡½æ•°<em>bddbClear</em></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Clear bddb entries from environment</span><br><span class=\"line\">bddbClear () &#123; </span><br><span class=\"line\">  local bddbVar</span><br><span class=\"line\">  for bddbVar in `set | grep -E &#x27;^bddb_[0-9_]*=&#x27; | cut -f1 -d= | xargs echo -n` ; do eval unset $bddbVar ; done</span><br><span class=\"line\">  bddbStateChange=1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™æ˜¯bearDropperé‡Œçš„ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œä¸€æ¬¡çœ‹è¿˜ä¸€å¤´é›¾æ°´ï¼Œç°åœ¨æ˜ç™½äº†ï¼Œsetæ˜¯è·å–å½“å‰bashç¯å¢ƒä¸‹æ‰€æœ‰çš„å˜é‡setï¼Œç„¶åç”¨grepè·å–ä»¥bddbå¼€å¤´çš„æ¡ç›®ï¼Œ<code>&#39;^bddb_[0-9_]*=&#39;</code>æ˜¾ç„¶å°±æ˜¯è·å–å½¢å¦‚bddb_xxx_xxx_xxx_xxxçš„æ¡ç›®ï¼Œé‚£å¦‚æœæˆ‘ä»¬è¦ä½¿å…¶å˜ä¸ºæ”¯æŒIPv6ï¼Œåœ¨ä¸æ”¹å˜bddbæ•°æ®ç»„ç»‡ç»“æ„çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„IPv6æ¡ç›®ä¸€å®šæ˜¯å½¢å¦‚<code>bddb_2a06_19af_19af_19af_19af_19af_19af_1234=0/1,timestamp1,...</code>çš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨å‰é¢çš„éƒ¨åˆ†å³å¯ï¼ŒæŠŠ<code>&#39;^bddb_[0-9_]*=&#39;</code>æ”¹ä¸º<code>&#39;^bddb_[a-fA-F0-9_]*=&#39;</code>åº”è¯¥å°±å¯ä»¥åŒ¹é…ä¸Šäº†ï¼Œå› ä¸ºIPv6ä¸å…‰æœ‰æ•°å­—0-9ï¼Œè¿˜æœ‰å­—æ¯a-fï¼ŒA-Fï¼ŒæŠŠå®ƒä»¬åŠ åˆ°æ­£åˆ™é‡Œå°±è¡Œäº†ã€‚ä¿®æ”¹åå‡½æ•°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">bddbClear () &#123; </span><br><span class=\"line\">  local bddbVar</span><br><span class=\"line\">  for bddbVar in `set | grep -E &#x27;^bddb_[a-fA-F0-9_]*=&#x27; | cut -f1 -d= | xargs echo -n` ; do eval unset $bddbVar ; done</span><br><span class=\"line\">  bddbStateChange=1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å‡½æ•°bddbCount\"><a href=\"#å‡½æ•°bddbCount\" class=\"headerlink\" title=\"å‡½æ•°bddbCount\"></a>å‡½æ•°<em>bddbCount</em></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">bddbCount () &#123; set | grep -E &#x27;^bddb_[0-9_]*=&#x27; | wc -l ; &#125;</span><br></pre></td></tr></table></figure>\n<p>ä¸€ä¸ªå’Œä¸Šé¢ç±»ä¼¼çš„å‡½æ•°ï¼Œé—­ç€çœ¼ç›ä¿®æ”¹ä¸ºï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">bddbCount () &#123; set | grep -E &#x27;^bddb_[a-fA-F0-9_]*=&#x27; | wc -l ; &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"å‡½æ•°bddbLoad-å’ŒbddbSave\"><a href=\"#å‡½æ•°bddbLoad-å’ŒbddbSave\" class=\"headerlink\" title=\"å‡½æ•°bddbLoad å’ŒbddbSave\"></a>å‡½æ•°<em>bddbLoad</em> å’Œ<em>bddbSave</em></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Loads existing bddb file into environment</span><br><span class=\"line\"># Arg: $1 = file, $2 = type (bddb/bddbz), $3 = </span><br><span class=\"line\">bddbLoad () &#123; </span><br><span class=\"line\">  local loadFile=&quot;$1.$2&quot; fileType=&quot;$2&quot;</span><br><span class=\"line\">  if [ &quot;$fileType&quot; = bddb -a -f &quot;$loadFile&quot; ] ; then</span><br><span class=\"line\">    . &quot;$loadFile&quot;</span><br><span class=\"line\">  elif [ &quot;$fileType&quot; = bddbz -a -f &quot;$loadFile&quot; ] ; then</span><br><span class=\"line\">    local tmpFile=&quot;`mktemp`&quot;</span><br><span class=\"line\">    zcat $loadFile &gt; &quot;$tmpFile&quot;</span><br><span class=\"line\">    . &quot;$tmpFile&quot;</span><br><span class=\"line\">    rm -f &quot;$tmpFile&quot;</span><br><span class=\"line\">  fi</span><br><span class=\"line\">  bddbStateChange=0</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ä»”ç»†çœ‹äº†ä¹‹åï¼Œå‘ç°æ²¡æœ‰ä¿®æ”¹çš„ç‚¹ï¼Œè¿™ä¸ªå‡½æ•°åº”è¯¥æ˜¯å®Œç¾æ”¯æŒæˆ‘ä»¬çš„IPv6æ•°æ®æ ¼å¼çš„ï¼Œå®ƒçš„ä½œç”¨å°±åªæ˜¯æŠŠ<code>/tmp/bearDropper.bddb</code>æ–‡ä»¶æŒ‰è¡Œè¯»å–åˆ°bashç¯å¢ƒä¸­ï¼Œå› ä¸ºé‡Œé¢æ­£å¥½æ˜¯ç±»ä¼¼äºvar&#x3D;contentçš„æ ¼å¼ï¼Œè¿™ä¹Ÿä¸ä¸Šé¢çš„bddbClearç›´æ¥ä»ç¯å¢ƒé‡Œæ¸…é™¤å˜é‡çš„æ“ä½œå¯¹ä¸Šäº†ã€‚bearDropperå°±æ˜¯æŠŠè¿™ä¸ªæ–‡ä»¶é‡Œçš„æ‰€æœ‰è¡Œå½“ä½œå˜é‡å‚¨å­˜åˆ°bashç¯å¢ƒé‡Œï¼Œç„¶ååœ¨è¿›è¡Œä¸€ç³»åˆ—çš„æ“ä½œçš„ã€‚</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Saves environment bddb entries to file, Arg: $1 = file to save in</span><br><span class=\"line\">bddbSave () &#123; </span><br><span class=\"line\">  local saveFile=&quot;$1.$2&quot; fileType=&quot;$2&quot;</span><br><span class=\"line\">  if [ &quot;$fileType&quot; = bddb ] ; then</span><br><span class=\"line\">    set | grep -E &#x27;^bddb_[a-f,A-F,0-9_]*=&#x27; | sed s/\\&#x27;//g &gt; &quot;$saveFile&quot;</span><br><span class=\"line\">  elif [ &quot;$fileType&quot; = bddbz ] ; then</span><br><span class=\"line\">    set | grep -E &#x27;^bddb_[a-f,A-F,0-9_]*=&#x27; | sed s/\\&#x27;//g | gzip -c &gt; &quot;$saveFile&quot;</span><br><span class=\"line\">  fi</span><br><span class=\"line\">  bddbStateChange=0 </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™ä¸ªsaveå‡½æ•°åŒç†ï¼ŒæŠŠç¯å¢ƒä¸­çš„bddbå˜é‡çº¯å­˜åˆ°æ–‡ä»¶ä¸­å»ï¼Œåº”è¯¥æ˜¯ä¸€ç³»åˆ—æ“ä½œæœ€åçš„ä¿å­˜å·¥ä½œã€‚ä»…éœ€ä¿®æ”¹bddbçš„æ­£åˆ™éƒ¨åˆ†å³å¯ã€‚</p>\n<h3 id=\"å‡½æ•°bddbEnableStatus\"><a href=\"#å‡½æ•°bddbEnableStatus\" class=\"headerlink\" title=\"å‡½æ•°bddbEnableStatus\"></a>å‡½æ•°<em>bddbEnableStatus</em></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Set bddb record status=1, update ban time flag with newest</span><br><span class=\"line\"># Args: $1=IP Address $2=timeFlag</span><br><span class=\"line\">bddbEnableStatus () &#123;</span><br><span class=\"line\">  local record=`echo $1 | sed -e &#x27;s/\\./_/g&#x27; -e &#x27;s/^/bddb_/&#x27;`</span><br><span class=\"line\">  local newestTime=`bddbGetTimes $1 | sed &#x27;s/.* //&#x27; | xargs echo $2 | tr \\  &#x27;\\n&#x27; | sort -n | tail -1 `</span><br><span class=\"line\">  eval $record=&quot;1,$newestTime&quot;</span><br><span class=\"line\">  bddbStateChange=1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è§£é‡Šçš„å¾ˆæ¸…æ¥šï¼Œå°±æ˜¯æŠŠè¾¾åˆ°banæ ‡å‡†çš„IP statusæ”¹ä¸º1ï¼Œtimestampæ›´æ–°ä¸ºå°ç¦æ—¶timestampã€‚æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„ç‚¹ä¸»è¦åœ¨äºå‡½æ•°ä½“å†…ç¬¬ä¸€æ¡ï¼Œæ³¨æ„å®ƒçš„ä½œç”¨æ˜¯æŠŠIPä¸­çš„.è½¬æ¢ä¸º_ï¼Œå¹¶åœ¨å¼€å¤´æ·»åŠ bddb_ï¼Œæˆ‘ä»¬çš„IPv6åˆ™åº”è¯¥æ˜¯æŠŠï¼šè½¬ä¸º_å³å¯ã€‚åªè¦åœ¨sedåå†æ·»åŠ ä¸€ä¸ª<code>-e &#39;s/:/_/g&#39;</code>å³å¯ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">bddbEnableStatus () &#123;</span><br><span class=\"line\">  local record=`echo $1 | sed -e &#x27;s/\\./_/g&#x27; -e &#x27;s/:/_/g&#x27; -e &#x27;s/^/bddb_/&#x27;`</span><br><span class=\"line\">  local newestTime=`bddbGetTimes $1 | sed &#x27;s/.* //&#x27; | xargs echo $2 | tr \\  &#x27;\\n&#x27; | sort -n | tail -1 `</span><br><span class=\"line\">  eval $record=&quot;1,$newestTime&quot;</span><br><span class=\"line\">  bddbStateChange=1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>æ³¨æ„åˆ°ä¸‹ä¸€è¡Œè¿˜ä½¿ç”¨äº†<em>bddbGetTimes</em> å‡½æ•°ï¼Œæˆ‘ä»¬å°±åœ¨æ¥ä¸‹æ¥çœ‹ä¸€çœ‹è¿™ä¸ªå‡½æ•°ï¼š</p>\n<h3 id=\"å‡½æ•°bddbGetTimesï¼Œ-bddbGetStatus-å’ŒbddbGetRecord\"><a href=\"#å‡½æ•°bddbGetTimesï¼Œ-bddbGetStatus-å’ŒbddbGetRecord\" class=\"headerlink\" title=\"å‡½æ•°bddbGetTimesï¼Œ bddbGetStatus å’ŒbddbGetRecord\"></a>å‡½æ•°<em>bddbGetTimes</em>ï¼Œ <em>bddbGetStatus</em> å’Œ<em>bddbGetRecord</em></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Args: $1=IP Address</span><br><span class=\"line\">bddbGetTimes () &#123;</span><br><span class=\"line\">  bddbGetRecord $1 | cut -d, -f2-</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">bddbGetStatus () &#123;</span><br><span class=\"line\">  bddbGetRecord $1 | cut -d, -f1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>åˆè°ƒç”¨äº†<em>bddbGetRecord</em> å‡½æ•°ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># retrieve single IP record, Args: $1=IP</span><br><span class=\"line\">bddbGetRecord () &#123;</span><br><span class=\"line\">  local record</span><br><span class=\"line\">  record=`echo $1 | sed -e &#x27;s/\\./_/g&#x27; -e &#x27;s/^/bddb_/&#x27;`</span><br><span class=\"line\">  eval echo \\$$record</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ç»“åˆèµ·æ¥çœ‹ï¼ŒbddbGetRecordæ˜¯è·å–äº†å½“å‰bashç¯å¢ƒé‡Œ$bddb_ipçš„å€¼ä½œä¸ºå‡½æ•°è¿”å›ï¼Œåœ¨bddbGetTimesé‡Œç”¨cutå‡½æ•°ï¼Œè·å–äº†statusåé¢çš„ä¸€ç³»åˆ—timestampsã€‚æˆ‘ä»¬ä¹Ÿåªè¦å¢åŠ æ›¿æ¢ipåœ°å€ä¸­çš„.å’Œ:å³å¯ï¼šåªè¦åœ¨sedåå†æ·»åŠ ä¸€ä¸ª<code>-e &#39;s/:/_/g&#39;</code>ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">bddbGetRecord () &#123;</span><br><span class=\"line\">  local record</span><br><span class=\"line\">  record=`echo $1 | sed -e &#x27;s/\\./_/g&#x27; -e &#x27;s/:/_/g&#x27; -e &#x27;s/^/bddb_/&#x27;`</span><br><span class=\"line\">  eval echo \\$$record</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>è¿™æ ·å›åˆ°ä¸Šä¸€ä¸ªå‡½æ•°<em>bddbGetTimes</em> ï¼Œ$newestTimeä¹Ÿå¾ˆè¾¾æ„äº†ï¼Œå°±æ˜¯è·å–æœ€åä¸€ä¸ªtimestamp, ä¹Ÿå³å°ç¦IPæ—¶çš„timestamp</p>\n<h3 id=\"å‡½æ•°bddbAddRecord\"><a href=\"#å‡½æ•°bddbAddRecord\" class=\"headerlink\" title=\"å‡½æ•°bddbAddRecord\"></a>å‡½æ•°<em>bddbAddRecord</em></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Args: $1 = IP address, $2 [$3 ...] = timestamp (seconds since epoch)</span><br><span class=\"line\">bddbAddRecord () &#123;</span><br><span class=\"line\">  local ip=&quot;`echo &quot;$1&quot; | tr . _`&quot; ; shift</span><br><span class=\"line\">  local newEpochList=&quot;$@&quot; status=&quot;`eval echo \\\\\\$bddb_$ip | cut -f1 -d,`&quot;</span><br><span class=\"line\">  local oldEpochList=&quot;`eval echo \\\\\\$bddb_$ip | cut -f2- -d,  | tr , \\ `&quot; </span><br><span class=\"line\">  local epochList=`echo $oldEpochList $newEpochList | xargs -n 1 echo | sort -un | xargs echo -n | tr \\  ,`</span><br><span class=\"line\">  [ -z &quot;$status&quot; ] &amp;&amp; status=0</span><br><span class=\"line\">  eval &quot;bddb_$ip&quot;\\=\\&quot;$status,$epochList\\&quot;</span><br><span class=\"line\">  bddbStateChange=1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å…·ä½“æ²¡çœ‹å¤ªæ˜ç™½ï¼Œä½†æ˜¯è‚¯å®šæ˜¯åœ¨æ¯ä¸ªrecordåé¢æ·»åŠ ä¸Šæ–°çš„timestampç”¨åˆ°çš„å‡½æ•°ã€‚å°è¯•ä¿®æ”¹ç¬¬ä¸€è¡Œï¼Œä¹Ÿæ˜¯æŠŠipåœ°å€ä¸­çš„.å’Œ:ä¿®æ”¹ä¸º_ï¼Œè¿™é‡Œç”¨åˆ°äº† tr å‘½ä»¤ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸ç”¨sedäº† ğŸ˜‚ã€‚ç±»ä¼¼çš„ä¿®æ”¹æ–¹å¼ï¼ŒåªåŠ¨äº†ç¬¬ä¸€è¡Œï¼Œå…¶ä»–è¡Œæ²¡å¤ªæ˜ç™½ï¼Œä½†åº”è¯¥ä¹Ÿæ— éœ€ä¿®æ”¹ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">bddbAddRecord () &#123;</span><br><span class=\"line\">  local ip=&quot;`echo &quot;$1&quot; | tr . _ | tr : _`&quot; ; shift</span><br><span class=\"line\">  local newEpochList=&quot;$@&quot; status=&quot;`eval echo \\\\\\$bddb_$ip | cut -f1 -d,`&quot;</span><br><span class=\"line\">  local oldEpochList=&quot;`eval echo \\\\\\$bddb_$ip | cut -f2- -d,  | tr , \\ `&quot; </span><br><span class=\"line\">  local epochList=`echo $oldEpochList $newEpochList | xargs -n 1 echo | sort -un | xargs echo -n | tr \\  ,`</span><br><span class=\"line\">  [ -z &quot;$status&quot; ] &amp;&amp; status=0</span><br><span class=\"line\">  eval &quot;bddb_$ip&quot;\\=\\&quot;$status,$epochList\\&quot;</span><br><span class=\"line\">  bddbStateChange=1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å‡½æ•°bddbRemoveRecord\"><a href=\"#å‡½æ•°bddbRemoveRecord\" class=\"headerlink\" title=\"å‡½æ•°bddbRemoveRecord\"></a>å‡½æ•°<em>bddbRemoveRecord</em></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Args: $1 = IP address</span><br><span class=\"line\">bddbRemoveRecord () &#123;</span><br><span class=\"line\">  local ip=&quot;`echo &quot;$1&quot; | tr . _`&quot;</span><br><span class=\"line\">  eval unset bddb_$ip</span><br><span class=\"line\">  bddbStateChange=1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>å’Œä¸Šé¢ä¸€æ ·ï¼Œé—­ç€çœ¼ä¿®æ”¹ï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Args: $1 = IP address</span><br><span class=\"line\">bddbRemoveRecord () &#123;</span><br><span class=\"line\">  local ip=&quot;`echo &quot;$1&quot; | tr . _ | tr : _`&quot;</span><br><span class=\"line\">  eval unset bddb_$ip</span><br><span class=\"line\">  bddbStateChange=1</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"å‡½æ•°bddbGetAllIPs\"><a href=\"#å‡½æ•°bddbGetAllIPs\" class=\"headerlink\" title=\"å‡½æ•°bddbGetAllIPs\"></a>å‡½æ•°<em>bddbGetAllIPs</em></h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Returns all IPs (not CIDR) present in records</span><br><span class=\"line\">bddbGetAllIPs () &#123; </span><br><span class=\"line\">  local ipRaw record</span><br><span class=\"line\">  set | grep -E &#x27;^bddb_[0-9_]*=&#x27; | tr \\&#x27; \\  | while read record ; do</span><br><span class=\"line\">    ipRaw=`echo $record | cut -f1 -d= | sed &#x27;s/^bddb_//&#x27;`</span><br><span class=\"line\">    if [ `echo $ipRaw | tr _ \\  | wc -w` -eq 4 ] ; then</span><br><span class=\"line\">      echo $ipRaw | tr _ .</span><br><span class=\"line\">    fi</span><br><span class=\"line\">  done</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>é©¾è½»å°±ç†Ÿäº†ï¼Œå°±æ˜¯æŠŠbashç¯å¢ƒé‡Œçš„bddbå˜é‡å…¨éƒ¨è½¬æ¢ä¸ºåŸå§‹çš„IPåœ°å€ï¼Œé‚£ä¹ˆçœ‹é‡Œé¢çš„ifè¯­å¥ï¼ŒæŒ‰ç…§_åˆ†å‰²åï¼Œå¦‚æœæ•°é‡ä¸º4ï¼Œé‚£å°±æŠŠ_æ›¿æ¢å›.,è¿™é‡Œæ˜æ˜¾æ˜¯IPv4åœ°å€çš„æ›¿æ¢ï¼Œè¦æ·»åŠ åˆ°IPv6ï¼Œåªéœ€æ·»åŠ ä¸€ä¸ªelseè¯­å¥ï¼Œé‡Œé¢å†™ä¸Š<code>echo $ipRaw | tr _ :</code>ã€‚åŸä½œè€…è¿™é‡Œç”¨4æ¥ç¡®å®šï¼Œè‚¯å®šæ˜¯ä¸ºäº†å¥å£®æ€§ï¼Œå› ä¸ºä¸æ˜¯4çš„æƒ…å†µï¼Œæœ‰å¯èƒ½æ˜¯å‰é¢çš„IPåœ°å€è·å–ä¸æ­£ç¡®ï¼Œé‚£æ ·æœ‰é—®é¢˜çš„IPåœ°å€å°±ä¸ä¼šè¿›å…¥åˆ°åç»­çš„å¤„ç†ä¸­ï¼Œæˆ‘ä»¬é©¾åˆ°elseé‡Œå…¶å®æ˜¯å­˜åœ¨æ½œåœ¨é—®é¢˜çš„ï¼Œä½†æ˜¯ç®¡ä»–ï¼Œå…ˆå¹²äº†å†è¯´ã€‚æœ‰bugå†ä¿®å§ã€‚ã€‚ã€‚ã€‚  ğŸ˜‚<br>ä¿®æ”¹åï¼š</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">bddbGetAllIPs () &#123; </span><br><span class=\"line\">  local ipRaw record</span><br><span class=\"line\">  set | grep -E &#x27;^bddb_[a-f,A-F,0-9_]*=&#x27; | tr \\&#x27; \\  | while read record ; do</span><br><span class=\"line\">    ipRaw=`echo $record | cut -f1 -d= | sed &#x27;s/^bddb_//&#x27;`</span><br><span class=\"line\">    if [ `echo $ipRaw | tr _ \\  | wc -w` -eq 4 ] ; then</span><br><span class=\"line\">      echo $ipRaw | tr _ .</span><br><span class=\"line\">    else</span><br><span class=\"line\">      echo $ipRaw | tr _ :</span><br><span class=\"line\">    fi</span><br><span class=\"line\">  done</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"æ€»ç»“\"><a href=\"#æ€»ç»“\" class=\"headerlink\" title=\"æ€»ç»“\"></a>æ€»ç»“</h2><p>å¯¹æ¯”äº†ä¸€ä¸‹ï¼Œå¥½åƒä¿®æ”¹ä»¥ä¸Šè¿™äº›å‡½æ•°å°±è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„äº†ï¼Œå¯ä»¥çœ‹å‡ºï¼ŒbearDropperå†™çš„æ°´å¹³è¿˜æ˜¯å¾ˆé«˜çš„ï¼Œä»”ç»†é˜…è¯»å°±èƒ½å‘ç°ï¼Œæˆ‘ä»¬ä»æœªæ¶‰åŠåˆ°å…³äºå°ç¦æ¡ä»¶çš„é€»è¾‘åˆ¤æ–­ï¼Œå› ä¸ºè¿™éƒ¨åˆ†å‡½æ•°å’Œä¸»ä½“è¿‡ç¨‹å†™çš„ä¹Ÿå¾ˆå·§å¦™ã€‚ä¸è¿‡è€ƒè™‘åˆ°è¿™äº›å‡½æ•°å’Œåé¢çš„å¤„ç†è¿‡ç¨‹ä¹Ÿä¸»è¦æ˜¯å¯¹åé¢çš„timestampè¿›è¡Œå–å€¼å’Œåˆ¤æ–­ï¼Œè¿™äº›éƒ¨åˆ†æˆ‘ä»¬éƒ½æ˜¯æœªè¿›è¡Œä¿®æ”¹çš„ã€‚å…³äºbearDropperçš„é€»è¾‘åˆ¤æ–­å’Œä¸»ä½“ç¨‹åºéƒ¨åˆ†ï¼Œæœ‰ç©ºåœ¨å¦ä¸€ç‰‡æ–‡ç« ä¸­åœ¨è§£è¯»å§ã€‚ã€‚ã€‚</p>\n<p>æˆ‘ä¿®æ”¹å¥½çš„bearDropperä¹Ÿä¸Šä¼ è‡³æˆ‘çš„<a href=\"https://github.com/xXiaoXiang/bearDropper\">ä»£ç ä»“åº“</a>, æœ‰éœ€è¦çš„å¯ä»¥ç›´æ¥åœ¨ä»“åº“é¦–é¡µREADMEé‡Œçš„é“¾æ¥ä¸€é”®å®‰è£…ä½¿ç”¨ã€‚</p>\n","categories":["æŠ€æœ¯"],"tags":["æŠ˜è…¾","OpenWrt","ç½‘ç»œ"]}]